"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _vue=require("vue"),_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_size=require("../../hooks/size"),_dom=require("../../tools/dom"),_utils=require("../../tools/utils"),_event=require("../../tools/event"),_input=_interopRequireDefault(require("../../input/src/input")),_vn=require("../../tools/vn");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function isOptionVisible(e){return!1!==e.visible}function getOptUniqueId(){return _xeUtils.default.uniqueId("opt_")}var _default=(0,_vue.defineComponent)({name:"VxeSelect",props:{modelValue:null,clearable:Boolean,placeholder:{type:String,default:function(){return _xeUtils.default.eqNull(_conf.default.select.placeholder)?_conf.default.i18n("vxe.base.pleaseSelect"):_conf.default.select.placeholder}},loading:Boolean,disabled:Boolean,multiple:Boolean,multiCharOverflow:{type:[Number,String],default:function(){return _conf.default.select.multiCharOverflow}},prefixIcon:String,placement:String,options:Array,optionProps:Object,optionGroups:Array,optionGroupProps:Object,optionConfig:Object,className:[String,Function],popupClassName:[String,Function],max:{type:[String,Number],default:null},size:{type:String,default:function(){return _conf.default.select.size||_conf.default.size}},filterable:Boolean,filterMethod:Function,remote:Boolean,remoteMethod:Function,emptyText:String,optionId:{type:String,default:function(){return _conf.default.select.optionId}},optionKey:Boolean,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},emits:["update:modelValue","change","clear","blur","focus"],setup:function(g,e){function E(e,t){return e&&(_xeUtils.default.isString(e)&&(e=T[e]||null),_xeUtils.default.isFunction(e))?(0,_vn.getSlotVNs)(e(t)):[]}function v(t){var e=L.fullOptionList,n=L.fullGroupList,i=k.value,l=N.value;if(i)for(var o=0;o<n.length;o++){var u=n[o];if(u.options)for(var a=0;a<u.options.length;a++){var r=u.options[a];if(t===r[l])return r}}return e.find(function(e){return t===e[l]})}function l(t){var e=L.remoteValueList,n=P.value,e=(e=e.find(function(e){return t===e.key}))?e.result:null;return _xeUtils.default.toValueString(e?e[n]:t)}function o(e){var t=P.value,n=v(e);return _xeUtils.default.toValueString(n?n[t]:e)}function u(){var e=g.filterable,t=g.filterMethod,n=L.fullOptionList,i=L.fullGroupList,l=L.searchValue,o=k.value,u=Z.value,a=P.value;return o?L.visibleGroupList=e&&t?i.filter(function(e){return isOptionVisible(e)&&t({group:e,option:null,searchValue:l})}):e?i.filter(function(e){return isOptionVisible(e)&&(!l||-1<"".concat(e[u]).indexOf(l))}):i.filter(isOptionVisible):L.visibleOptionList=e&&t?n.filter(function(e){return isOptionVisible(e)&&t({group:null,option:e,searchValue:l})}):e?n.filter(function(e){return isOptionVisible(e)&&(!l||-1<"".concat(e[a]).indexOf(l))}):n.filter(isOptionVisible),(0,_vue.nextTick)()}function n(){function t(e){A(e)||(e[l]=getOptUniqueId())}var e=L.fullOptionList,n=L.fullGroupList,i=G.value,l=ee();n.length?n.forEach(function(e){t(e),e[i]&&e[i].forEach(t)}):e.length&&e.forEach(t),u()}function O(e){var t=N.value;e&&(L.currentOption=e,L.currentValue=e[t])}function p(i,l){(0,_vue.nextTick)().then(function(){var e,t,n;i&&(e=x.value,t=y.value.querySelector("[optid='".concat(A(i),"']")),e)&&t&&(n=e.offsetHeight,l?t.offsetTop+t.offsetHeight-e.scrollTop>n&&(e.scrollTop=t.offsetTop+t.offsetHeight-n):(t.offsetTop+5<e.scrollTop||t.offsetTop+5>e.scrollTop+e.clientHeight)&&(e.scrollTop=t.offsetTop-5))})}function i(){(0,_vue.nextTick)().then(function(){var e,t,n,i,l,o,u,a=g.transfer,r=g.placement,s=L.panelIndex,c=h.value,f=y.value;if(f&&c)return e=c.offsetHeight,t=c.offsetWidth,n=f.offsetHeight,f=f.offsetWidth,s={zIndex:s},i=(c=(0,_dom.getAbsolutePos)(c)).boundingTop,u=c.boundingLeft,l=c.visibleHeight,c=c.visibleWidth,o="bottom",a?(a=i+e,"top"===r?(o="top",a=i-n):r||(l<a+n+5&&(o="top",a=i-n),a<5&&(o="bottom",a=i+e)),c<(u=u)+f+5&&(u-=u+f+5-c),u<5&&(u=5),Object.assign(s,{left:"".concat(u,"px"),top:"".concat(a,"px"),minWidth:"".concat(t,"px")})):"top"===r?(o="top",s.bottom="".concat(e,"px")):r||l<i+e+n&&5<i-e-n&&(o="top",s.bottom="".concat(e,"px")),L.panelStyle=s,L.panelPlacement=o,(0,_vue.nextTick)()})}function U(e,t){te(t,null),I()}function V(e,t,n){var i=g.modelValue,l=g.multiple,o=L.remoteValueList;l?(l=void 0,l=i?-1===i.indexOf(t)?i.concat([t]):i.filter(function(e){return e!==t}):[t],(i=o.find(function(e){return e.key===t}))?i.result=n:o.push({key:t,result:n}),K(e,l)):(L.remoteValueList=[{key:t,result:n}],K(e,t),I())}function w(e){var t=g.disabled,n=L.visiblePanel;t||n&&(t=y.value,((0,_dom.getEventTargetNode)(e,t).flag?i:I)())}function q(e){var t,n=g.disabled,i=L.visiblePanel;n||(n=h.value,t=y.value,L.isActivated=(0,_dom.getEventTargetNode)(e,n).flag||(0,_dom.getEventTargetNode)(e,t).flag,i&&!L.isActivated&&I())}function D(e){var t,n,i,l,o,u,a=g.clearable,r=g.disabled,s=L.visiblePanel,c=L.currentValue,f=L.currentOption;r||(r=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.TAB),t=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER),u=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ESCAPE),n=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_UP),i=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ARROW_DOWN),l=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.DELETE),o=(0,_event.hasEventKey)(e,_event.EVENT_KEYS.SPACEBAR),r&&(L.isActivated=!1),s?u||r?I():t?(e.preventDefault(),e.stopPropagation(),V(e,c,f)):n||i?(e.preventDefault(),u=(s=function(e,t){var n,i,l,o,u=L.visibleOptionList,a=L.visibleGroupList,r=k.value,s=N.value,c=G.value;if(r)for(var f=0;f<a.length;f++){var v=a[f],p=v[c],d=v.disabled;if(p)for(var _=0;_<p.length;_++){var h=isOptionVisible(b=p[_]),m=d||b.disabled;if(n||m||(n=b),o&&h&&!m&&(l=b,!t))return{offsetOption:l};if(e===b[s]){if(o=b,t)return{offsetOption:i}}else h&&!m&&(i=b)}}else for(_=0;_<u.length;_++){var b,m=(b=u[_]).disabled;if(n||m||(n=b),o&&!m&&(l=b,!t))return{offsetOption:l};if(e===b[s]){if(o=b,t)return{offsetOption:i}}else m||(i=b)}return{firstOption:n}}(c,n)).firstOption,(r=s.offsetOption)||v(c)||(r=u),O(r),p(r,i)):o&&e.preventDefault():(n||i||t||o)&&L.isActivated&&(e.preventDefault(),d()),L.isActivated&&l&&a&&te(e,null))}function F(){I()}function R(e){g.disabled||(L.isActivated=!0),f.dispatchEvent("focus",{},e)}function j(e){L.isActivated=!1,f.dispatchEvent("blur",{},e)}function B(e){L.searchValue=e}function $(){L.isActivated=!0}function z(e){e=e.$event,(0,_event.hasEventKey)(e,_event.EVENT_KEYS.ENTER)&&(e.preventDefault(),e.stopPropagation())}function _(e){e.$event.preventDefault(),(L.visiblePanel?I:d)()}var a,T=e.slots,r=e.emit,s=(0,_vue.inject)("$xeform",null),c=(0,_vue.inject)("$xeformiteminfo",null),M=_xeUtils.default.uniqueId(),Y=(0,_size.useSize)(g),L=(0,_vue.reactive)({inited:!1,staticOptions:[],fullGroupList:[],fullOptionList:[],visibleGroupList:[],visibleOptionList:[],remoteValueList:[],panelIndex:0,panelStyle:{},panelPlacement:null,currentOption:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1,searchValue:"",searchLoading:!1}),h=(0,_vue.ref)(),m=(0,_vue.ref)(),b=(0,_vue.ref)(),x=(0,_vue.ref)(),y=(0,_vue.ref)(),H={refElem:h},S={xID:M,props:g,context:e,reactData:L,getRefMaps:function(){return H}},f={},t=(0,_vue.computed)(function(){return g.optionProps||{}}),W=(0,_vue.computed)(function(){return g.optionGroupProps||{}}),P=(0,_vue.computed)(function(){return t.value.label||"label"}),N=(0,_vue.computed)(function(){return t.value.value||"value"}),Z=(0,_vue.computed)(function(){return W.value.label||"label"}),G=(0,_vue.computed)(function(){return W.value.options||"options"}),X=(0,_vue.computed)(function(){var e=g.modelValue,t=g.multiple,n=g.max;return!(!t||!n)&&(e?e.length:0)>=_xeUtils.default.toNumber(n)}),C=(0,_vue.computed)(function(){return Object.assign({},_conf.default.select.optionConfig,g.optionConfig)}),k=(0,_vue.computed)(function(){return L.fullGroupList.some(function(e){return e.options&&e.options.length})}),J=(0,_vue.computed)(function(){return _xeUtils.default.toNumber(g.multiCharOverflow)}),Q=(0,_vue.computed)(function(){var e=g.modelValue,t=g.multiple,n=g.remote,i=J.value;return e&&t?(t=_xeUtils.default.isArray(e)?e:[e],(n?t.map(l):t.map(function(e){e=o(e);return 0<i&&e.length>i?"".concat(e.substring(0,i),"..."):e})).join(", ")):(n?l:o)(e)}),ee=function(){return C.value.keyField||g.optionId||"_X_OPTION_KEY"},A=function(e){e=e[ee()];return e?encodeURIComponent(e):""},d=function(){var e=g.loading,t=g.disabled,n=g.filterable;e||t||(clearTimeout(a),L.inited||(L.inited=!0),L.isActivated=!0,L.animatVisible=!0,n&&u(),setTimeout(function(){var e=g.modelValue,t=g.multiple,t=v(t&&e?e[0]:e);L.visiblePanel=!0,t&&(O(t),p(t)),g.filterable&&(0,_vue.nextTick)(function(){var e=b.value;e&&e.focus()})},10),L.panelIndex<(0,_utils.getLastZIndex)()&&(L.panelIndex=(0,_utils.nextZIndex)()),i())},I=function(){L.searchValue="",L.searchLoading=!1,L.visiblePanel=!1,a=window.setTimeout(function(){L.animatVisible=!1},350)},K=function(e,t){t!==g.modelValue&&(r("update:modelValue",t),f.dispatchEvent("change",{value:t},e),s)&&c&&s.triggerItemEvent(e,c.itemConfig.field,t)},te=function(e,t){L.remoteValueList=[],K(e,t),f.dispatchEvent("clear",{value:t},e)},ne=_xeUtils.default.debounce(function(){var e=g.remote,t=g.remoteMethod,n=L.searchValue;e&&t?(L.searchLoading=!0,Promise.resolve(t({searchValue:n})).then(function(){return(0,_vue.nextTick)()}).catch(function(){return(0,_vue.nextTick)()}).finally(function(){L.searchLoading=!1,u()})):u()},350,{trailing:!0}),ie=function(e,c){var f=g.optionKey,v=g.modelValue,p=g.multiple,d=L.currentValue,t=C.value,_=P.value,h=N.value,m=k.value,b=t.useKey,x=T.option;return e.map(function(t,e){var n=t.slots,i=t.className,l=t[h],o=p?v&&-1<v.indexOf(l):v===l,u=!m||isOptionVisible(t),a=(s=o,r=c,!!t.disabled||!(!r||!r.disabled)||!(!X.value||s)),r=A(t),s=n?n.default:null,n={option:t,group:null,$select:S};return u?(0,_vue.h)("div",{key:b||f?r:e,class:["vxe-select-option",i?_xeUtils.default.isFunction(i)?i(n):i:"",{"is--disabled":a,"is--selected":o,"is--hover":d===l}],optid:r,onMousedown:function(e){0===e.button&&e.stopPropagation()},onClick:function(e){a||V(e,l,t)},onMouseenter:function(){a||O(t)}},x?E(x,n):s?E(s,n):(0,_utils.formatText)((0,_utils.getFuncText)(t[_]))):null})},le=function(){var a=g.optionKey,e=L.visibleGroupList,t=C.value,r=Z.value,s=G.value,c=t.useKey,f=T.option;return e.map(function(e,t){var n=e.slots,i=e.className,l=A(e),o=e.disabled,n=n?n.default:null,u={option:e,group:e,$select:S};return(0,_vue.h)("div",{key:c||a?l:t,class:["vxe-optgroup",i?_xeUtils.default.isFunction(i)?i(u):i:"",{"is--disabled":o}],optid:l},[(0,_vue.h)("div",{class:"vxe-optgroup--title"},f?E(f,u):n?E(n,u):(0,_utils.getFuncText)(e[r])),(0,_vue.h)("div",{class:"vxe-optgroup--wrapper"},ie(e[s]||[],e))])})},f={dispatchEvent:function(e,t,n){r(e,Object.assign({$select:S,$event:n},t))},isPanelVisible:function(){return L.visiblePanel},togglePanel:function(){return(L.visiblePanel?I:d)(),(0,_vue.nextTick)()},hidePanel:function(){return L.visiblePanel&&I(),(0,_vue.nextTick)()},showPanel:function(){return L.visiblePanel||d(),(0,_vue.nextTick)()},refreshOption:u,focus:function(){var e=m.value;return L.isActivated=!0,e.blur(),(0,_vue.nextTick)()},blur:function(){return m.value.blur(),(L.isActivated=!1,_vue.nextTick)()}};Object.assign(S,f),(0,_vue.watch)(function(){return L.staticOptions},function(e){e.some(function(e){return e.options&&e.options.length})?(L.fullOptionList=[],L.fullGroupList=e):(L.fullGroupList=[],L.fullOptionList=e||[]),n()}),(0,_vue.watch)(function(){return g.options},function(e){L.fullGroupList=[],L.fullOptionList=e||[],n()}),(0,_vue.watch)(function(){return g.optionGroups},function(e){L.fullOptionList=[],L.fullGroupList=e||[],n()}),(0,_vue.onMounted)(function(){(0,_vue.nextTick)(function(){var e=g.options,t=g.optionGroups;t?L.fullGroupList=t:e&&(L.fullOptionList=e),n()}),_event.GlobalEvent.on(S,"mousewheel",w),_event.GlobalEvent.on(S,"mousedown",q),_event.GlobalEvent.on(S,"keydown",D),_event.GlobalEvent.on(S,"blur",F)}),(0,_vue.onUnmounted)(function(){_event.GlobalEvent.off(S,"mousewheel"),_event.GlobalEvent.off(S,"mousedown"),_event.GlobalEvent.off(S,"keydown"),_event.GlobalEvent.off(S,"blur")});return S.renderVN=function(){var e=g.className,t=g.popupClassName,n=g.transfer,i=g.disabled,l=g.loading,o=g.filterable,u=L.inited,a=L.isActivated,r=L.visiblePanel,s=Y.value,c=Q.value,f=T.default,v=T.header,p=T.footer,d=T.prefix;return(0,_vue.h)("div",{ref:h,class:["vxe-select",e?_xeUtils.default.isFunction(e)?e({$select:S}):e:"",((e={})["size--".concat(s)]=s,e["is--visivle"]=r,e["is--disabled"]=i,e["is--filter"]=o,e["is--loading"]=l,e["is--active"]=a,e)]},[(0,_vue.h)("div",{class:"vxe-select-slots",ref:"hideOption"},f?f({}):[]),(0,_vue.h)(_input.default,{ref:m,clearable:g.clearable,placeholder:g.placeholder,readonly:!0,disabled:i,type:"text",prefixIcon:g.prefixIcon,suffixIcon:l?_conf.default.icon.SELECT_LOADED:r?_conf.default.icon.SELECT_OPEN:_conf.default.icon.SELECT_CLOSE,modelValue:c,onClear:U,onClick:_,onFocus:R,onBlur:j,onSuffixClick:_},d?{prefix:function(){return d({})}}:{}),(0,_vue.h)(_vue.Teleport,{to:"body",disabled:!n||!u},[(0,_vue.h)("div",{ref:y,class:["vxe-table--ignore-clear vxe-select--panel",t?_xeUtils.default.isFunction(t)?t({$select:S}):t:"",((a={})["size--".concat(s)]=s,a["is--transfer"]=n,a["animat--leave"]=!l&&L.animatVisible,a["animat--enter"]=!l&&r,a)],placement:L.panelPlacement,style:L.panelStyle},u?[o?(0,_vue.h)("div",{class:"vxe-select--panel-search"},[(0,_vue.h)(_input.default,{ref:b,class:"vxe-select-search--input",modelValue:L.searchValue,clearable:!0,placeholder:_conf.default.i18n("vxe.select.search"),prefixIcon:_conf.default.icon.INPUT_SEARCH,"onUpdate:modelValue":B,onFocus:$,onKeydown:z,onChange:ne,onSearch:ne})]):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-select--panel-wrapper"},[v?(0,_vue.h)("div",{class:"vxe-select--panel-header"},v({})):(0,_vue.createCommentVNode)(),(0,_vue.h)("div",{class:"vxe-select--panel-body"},[(0,_vue.h)("div",{ref:x,class:"vxe-select-option--wrapper"},function(){var e=L.visibleGroupList,t=L.visibleOptionList,n=L.searchLoading,i=k.value;if(n)return[(0,_vue.h)("div",{class:"vxe-select--search-loading"},[(0,_vue.h)("i",{class:["vxe-select--search-icon",_conf.default.icon.SELECT_LOADED]}),(0,_vue.h)("span",{class:"vxe-select--search-text"},_conf.default.i18n("vxe.select.loadingText"))])];if(i){if(e.length)return le()}else if(t.length)return ie(t);return[(0,_vue.h)("div",{class:"vxe-select--empty-placeholder"},g.emptyText||_conf.default.i18n("vxe.select.emptyText"))]}())]),p?(0,_vue.h)("div",{class:"vxe-select--panel-footer"},p({})):(0,_vue.createCommentVNode)()])]:[])])])},(0,_vue.provide)("$xeselect",S),S},render:function(){return this.renderVN()}});exports.default=_default;